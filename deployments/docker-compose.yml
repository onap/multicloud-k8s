# Copyright 2018 Intel Corporation.
# Licensed under the Apache License, Version 2.0 (the "License");
# you may not use this file except in compliance with the License.
# You may obtain a copy of the License at
#     http://www.apache.org/licenses/LICENSE-2.0
# Unless required by applicable law or agreed to in writing, software
# distributed under the License is distributed on an "AS IS" BASIS,
# WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
# See the License for the specific language governing permissions and
# limitations under the License.

version: '2'

services:
  multicloud-k8s:
    image: ${IMAGE_NAME}
    networks:
      multicloud_net:
        ipv4_address: ${PLUGIN_IP}
    build:
      context: ./
      args:
        - HTTP_PROXY=${HTTP_PROXY}
        - HTTPS_PROXY=${HTTPS_PROXY}
        - NO_PROXY=${NO_PROXY}
    ports:
      - "8081:8081"
    environment:
      - CSAR_DIR=${CSAR_DIR}
      - KUBE_CONFIG_DIR=${KUBE_CONFIG_DIR}
      - DATABASE_TYPE=${DATABASE_TYPE}
      - DATABASE_IP=${DATABASE_IP}
      - AAI_SERVICE_URL=${AAI_SERVICE_URL}
      - AAI_USERNAME=${AAI_USERNAME}
      - AAI_PASSWORD=${AAI_PASSWORD}
      - PLUGINS_DIR=${PLUGINS_DIR}
      - HTTP_PROXY=${HTTP_PROXY}
      - HTTPS_PROXY=${HTTPS_PROXY}
      - NO_PROXY=${NO_PROXY},${DATABASE_IP}
    depends_on:
      - mongo
    links:
      - mongo
    volumes:
      - /opt/csar:/opt/csar
      - /opt/kubeconfig:/opt/kubeconfig
  mongo:
    image: mongo
    networks:
      multicloud_net:
        ipv4_address: ${DATABASE_IP}
    environment:
      - HTTP_PROXY=${HTTP_PROXY}
      - HTTPS_PROXY=${HTTPS_PROXY}
      - NO_PROXY=${NO_PROXY}

networks:
  multicloud_net:
    driver: bridge
    ipam:
      driver: default
      config:
      -
        subnet: 172.19.0.0/27
