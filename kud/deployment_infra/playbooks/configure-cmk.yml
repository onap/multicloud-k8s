---
# SPDX-license-identifier: Apache-2.0
##############################################################################
# Copyright (c) 2018
# All rights reserved. This program and the accompanying materials
# are made available under the terms of the Apache License, Version 2.0
# which accompanies this distribution, and is available at
# http://www.apache.org/licenses/LICENSE-2.0
##############################################################################

- import_playbook: preconfigure-cmk.yml
- hosts: kube-master[0]
  become: yes
  pre_tasks:
    - name: Load kud variables
      include_vars:
        file: kud-vars.yml
  vars:
    cmk_install_host: 'controller'

  tasks:
    - name: populate CMK installing hosts
      set_fact:
        cmk_install_host: "{{ inventory_hostname }}"
      when:
        inventory_hostname == 'localhost'

    - name: prepare CMK config file
      replace:
        dest: "{{ playbook_dir }}/../images/cmk-{{ cmk_install_host }}.yaml"
        regexp: '{{ item.pool }}=0'
        replace: '{{ item.pool }}={{ item.cores }}'
      with_items:
        - { pool: 'num-shared-cores', cores: '{{ cmk_shared_num_cores }}' }
        - { pool: 'num-exclusive-cores', cores: '{{ cmk_exclusive_num_cores }}' }

    - name: install CMK components
      command: "/usr/local/bin/kubectl create -f {{ playbook_dir }}/../images/cmk-{{ cmk_install_host }}.yaml"

